generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ===== ENUMS =====

enum UserStatus {
  PENDING
  ACTIVE
  BLOCKED
  BANNED
  INACTIVE
}

enum UserRole {
  USER
  CLAN_LEADER
  ADMIN
}

enum EventStatus {
  ACTIVE
  INACTIVE
}

enum GameType {
  ARMA_3
  ARMA_REFORGER
}

enum SlotStatus {
  FREE
  OCCUPIED
}

enum NodeType {
  COMMAND   // Mando principal (ej: ALPHA MANDO)
  SQUAD     // Escuadra (ej: BRAVO, CHARLIE)
  ELEMENT   // Elemento/sub-equipo (ej: HIERRO 1)
  SUPPORT   // Apoyo (ej: AEREO, MEDICO)
}

// ===== MODELOS =====

model User {
  id                String      @id @default(uuid())
  email             String?     @unique
  password          String?
  nickname          String
  discordId         String?     @unique
  discordUsername   String?
  
  status            UserStatus  @default(PENDING)
  avatarUrl         String?
  role              UserRole    @default(USER)
  
  clanId            String?
  clan              Clan?       @relation(fields: [clanId], references: [id], onDelete: SetNull)
  
  slots             Slot[]
  createdEvents     Event[]     @relation("EventCreator")
  auditLogs         AuditLog[]
  clanHistory       ClanHistory[]
  absences          Absence[]
  clanChangeRequests ClanChangeRequest[]
  
  createdAt         DateTime    @default(now())
  updatedAt         DateTime    @updatedAt
  
  @@index([clanId])
  @@index([status])
  @@index([discordId])
}

model Clan {
  id          String   @id @default(uuid())
  name        String   @unique
  tag         String?
  description String?
  avatarUrl   String?  // <-- AGREGAR ESTA LÍNEA
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  users              User[]
  clanChangeRequests ClanChangeRequest[]

  @@index([name])
}

model Event {
  id              String      @id @default(uuid())
  name            String
  description     String?
  briefing        String?     // Contenido HTML del briefing
  
  gameType        GameType
  status          EventStatus @default(ACTIVE)
  
  scheduledDate   DateTime
  
  creatorId       String
  creator         User        @relation("EventCreator", fields: [creatorId], references: [id])
  
  squads          Squad[]
  absences        Absence[]
  auditLogs       AuditLog[]
  communicationNodes CommunicationNode[]
  
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt
  
  @@index([status])
  @@index([scheduledDate])
  @@index([creatorId])
}

model Squad {
  id          String   @id @default(uuid())
  name        String   // Ej: "Alfa", "Bravo", "Reconocimiento"
  order       Int      // Para ordenar las escuadras

  frequency        String?  // Frecuencia interna de la escuadra (ej: "42.00")
  isCommand        Boolean  @default(false) // Si es nodo de mando
  parentSquadId    String?  // ID de la escuadra padre
  parentSquad      Squad?   @relation("SquadHierarchy", fields: [parentSquadId], references: [id], onDelete: SetNull)
  childSquads      Squad[]  @relation("SquadHierarchy")
  parentFrequency  String?  // Frecuencia para comunicarse con el padre
  
  eventId     String
  event       Event    @relation(fields: [eventId], references: [id], onDelete: Cascade)
  
  slots       Slot[]
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([eventId])
}

model Slot {
  id          String      @id @default(uuid())
  role        String      // Ej: "Fusilero", "Médico", "Líder de escuadra"
  order       Int         // Para ordenar los slots
  status      SlotStatus  @default(FREE)
  
  squadId     String
  squad       Squad       @relation(fields: [squadId], references: [id], onDelete: Cascade)
  
  userId      String?
  user        User?       @relation(fields: [userId], references: [id], onDelete: SetNull)
  
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  
  @@index([squadId])
  @@index([userId])
}

model ClanHistory {
  id          String   @id @default(uuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  previousClan String?
  newClan      String?
  reason       String?
  
  changedAt    DateTime @default(now())
  
  @@index([userId])
}

model Absence {
  id          String   @id @default(uuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  eventId     String
  event       Event    @relation(fields: [eventId], references: [id], onDelete: Cascade)
  
  reason      String?
  
  createdAt   DateTime @default(now())
  
  @@unique([userId, eventId])
  @@index([eventId])
}

model ClanChangeRequest {
  id              String   @id @default(uuid())
  
  userId          String
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  currentClanId   String?
  targetClanId    String
  targetClan      Clan     @relation(fields: [targetClanId], references: [id], onDelete: Cascade)
  
  status          String   @default("PENDING") // PENDING, APPROVED, REJECTED
  reason          String?
  
  reviewedBy      String?
  reviewedAt      DateTime?
  
  createdAt       DateTime @default(now())
  
  @@index([userId])
  @@index([targetClanId])
  @@index([status])
}

model CommunicationNode {
  id          String   @id @default(uuid())
  
  eventId     String
  event       Event    @relation(fields: [eventId], references: [id], onDelete: Cascade)
  
  // Identificación del nodo
  name        String   // "ALPHA MANDO", "BRAVO", "HIERRO 1", etc.
  frequency   String?  // Formato: "xxx.xx" (ej: "123.45", "48.00")
  type        NodeType // COMMAND, SQUAD, ELEMENT, SUPPORT
  
  // Jerarquía
  parentId    String?
  parent      CommunicationNode?  @relation("NodeHierarchy", fields: [parentId], references: [id], onDelete: Cascade)
  children    CommunicationNode[] @relation("NodeHierarchy")

  // Frecuencia padre
  parentFrequency String?
  
  // Posición visual (para guardar el layout del árbol)
  positionX   Float    @default(0)
  positionY   Float    @default(0)
  
  // Orden de visualización
  order       Int      @default(0)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([eventId])
  @@index([parentId])
}

model AuditLog {
  id          String   @id @default(uuid())
  
  action      String   // Ej: "USER_VALIDATED", "SLOT_ASSIGNED", "EVENT_CREATED"
  entity      String   // Ej: "User", "Event", "Slot"
  entityId    String
  
  userId      String?
  user        User?    @relation(fields: [userId], references: [id], onDelete: SetNull)
  
  eventId     String?
  event       Event?   @relation(fields: [eventId], references: [id], onDelete: SetNull)
  
  details     String?  // JSON con detalles adicionales
  
  createdAt   DateTime @default(now())
  
  @@index([entity, entityId])
  @@index([userId])
  @@index([createdAt])
}